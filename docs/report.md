# 調査レポート：パート勤怠 & 扶養内シミュレーター

## 1. 目的
- スタッフごとの勤怠を月間カレンダーで管理
- 日本語の「希望票（テキスト）」を解析し、**自動で勤務日・時間を割り付け**
- 103/106/130万円などの**扶養ライン**を意識した年収見込みを可視化
- CSV / Excel で出力し、既存運用（Excel）にも連携

## 2. 要求整理
- **AI解析（日本語）**：例「扶養の範囲内」「月火木のみ」「4時間」「祝日は休み」「15日は休み、22日は入れる」
- **出勤簿（カレンダー）**：クリックで出勤/休み、時間は0.25h刻み
- **年収見込み**：103/106/130ライン＋カスタムライン
- **出力**：CSV（今月/全体）、Excel（今月）
- **公開**：サーバ不要（GitHub Pages 芝居可）

## 3. 実装概要
- フロントエンドのみ（Vanilla JS）。**localStorage** に保存。
- **希望票解析**：`parseWishText()`  
  - 曜日の排他指定（のみ/だけ/以外/平日のみ）を検知  
  - 「勤務時間X時間」/「9:00-13:00」表現→時間算出  
  - 個別日付（「15日休み」「22日入れる」）を抽出
- **割付計画**：`planAutoAssignment()`  
  - 扶養希望＋時給→**月上限時間**を算出（cap/12/wage）  
  - 候補日の中から週あたり制限/既存入力を考慮して配分
- **適用**：`applyWishPlan()`  
  - 上書きON ＆ 排他指定あり → 他曜日を**強制で休みにリセット**  
  - 対象日に **hours** を一括代入（0.25刻み）

## 4. 祝日データ
- `holidays-jp.github.io` → 失敗時 `date.nager.at` へフォールバック
- 30日キャッシュ（`localStorage`）

## 5. 出力
- CSV：`Blob` + `URL.createObjectURL()` でダウンロード
- Excel：`xlsx` (CDN) でシート生成 → `writeFileXLSX`

## 6. 主要画面の流れ
1. スタッフを選択し、**時給**を保存
2. 希望票を貼付 → **AI解析して反映**  
   - 例）  
     ```
     扶養の範囲内で。
     月・火・木のみ出勤。
     勤務時間は4時間。
     祝日は休み。
     ```
3. カレンダーが自動で出勤（4.00h）に更新
4. 必要に応じて前月コピー、集計再計算、CSV/Excel出力

## 7. テスト観点
- 曜日表現：月火木のみ / 平日のみ / 火以外 など
- 時間表現：小数（4.5h）/ 時間帯（9:00-13:30）
- 個別指定：X日は休み / Y日は入れる
- 扶養ライン：103/106/130/カスタム
- 祝日：祝日休み指定の反映
- 上書きON：他曜日の強制OFFが効くか

## 8. 既知の課題 / 改善余地
- 自然言語の揺れが大きい希望票は完全網羅が難しい → 解析ルールの継続拡充で改善
- エッジケース（複数相反する指示が混在）の優先度設計
- 週ごとの最大勤務日数・時間など詳細ルールのGUI化
- 会社ルール（休憩・深夜割増）組み込み

## 9. ライセンス / 取り扱い
- 本成果物は社内向けツールとして提出。二次配布は提出先のポリシーに従うこと。

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>パート勤怠 & 扶養内シミュレーター</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js"></script>
  <style>
    :root{--b:#111827;--m:#6b7280;--bd:#e5e7eb;--bg:#fff;--p:#2563eb;--bad:#dc2626;}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:16px;color:var(--b);background:#f8fafc;}
    header h1{margin:0 0 8px;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .stack{display:flex;flex-direction:column;gap:10px;}
    .card{border:1px solid var(--bd);border-radius:14px;padding:12px;background:#fff;}
    .muted{color:var(--m);}
    .section-title{font-weight:700;margin:0 0 6px;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;}
    .tab{padding:6px 10px;border:1px solid #ddd;border-radius:999px;background:#f3f4f6;cursor:pointer;}
    .tab.active{background:#e0f2fe;border-color:#38bdf8;}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #d1d5db;background:#fff;cursor:pointer;transition:.15s;}
    .btn.primary{background:var(--p);color:#fff;border-color:var(--p);}
    .btn.warn{background:var(--bad);color:#fff;border-color:var(--bad);}
    .btn-active{background:var(--p)!important;color:#fff!important;border-color:var(--p)!important;}
    .badge{display:inline-block;font-size:12px;padding:2px 6px;border-radius:999px;background:#eef2ff;color:#3730a3;margin-left:6px;}
    .badge.holiday{background:#fee2e2;color:#991b1b;}
    #calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;}
    .day-head{font-weight:700;text-align:center;color:#64748b;}
    .day-cell{border:1px solid var(--bd);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:6px;background:#fff;}
    .day-title{display:flex;align-items:center;justify-content:space-between;gap:6px;flex-wrap:wrap;}
    .toggle{padding:6px 10px;border-radius:999px;text-align:center;cursor:pointer;user-select:none;}
    .toggle.on{background:#dcfce7;color:#166534;border:1px solid #22c55e;}
    .toggle.off{background:#fee2e2;color:#991b1b;border:1px solid #ef4444;}
    .time-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .time-row input[type="number"]{flex:1 1 120px;padding:6px 8px;border:1px solid #d1d5db;border-radius:8px;}
    .val-pill{min-width:64px;text-align:right;font-variant-numeric:tabular-nums;padding:4px 8px;border-radius:999px;background:#f1f5f9;color:#0f172a;}
    .stepper{display:flex;gap:4px;}
    .btn-step{padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;cursor:pointer;}
    .help{font-size:12px;color:#64748b;}
    .kpi{display:flex;gap:16px;flex-wrap:wrap;}
    .kpi-item{min-width:180px;}
    .bar-row{display:flex;align-items:center;gap:8px;}
    progress{width:220px;height:12px;}
    table{width:100%;border-collapse:collapse;}
    th,td{border:1px solid var(--bd);padding:6px 8px;text-align:center;}
    th.month{width:80px;}
    .note{font-size:12px;color:#6b7280;}
    textarea{width:100%;min-height:120px;padding:8px;border:1px solid #d1d5db;border-radius:8px;}
    input[type="text"],input[type="number"],input[type="month"],select{padding:6px 8px;border:1px solid #d1d5db;border-radius:8px;}
    @media (max-width:560px){#calendar{gap:6px}.day-cell{padding:6px}.val-pill{min-width:54px}progress{width:160px}}
  </style>
</head>
<body>

  <header class="stack">
    <h1>パート勤怠 & 扶養内シミュレーター</h1>
    <div class="note" id="holiday-status">祝日データ：—</div>
  </header>

  <section class="card stack">
    <h2 class="section-title">スタッフ管理</h2>
    <div id="emp-tabs" class="tabs"></div>

    <div class="row">
      <label>氏名 <input id="emp-name" type="text" placeholder="例：山田 花子" /></label>
      <label>時給(円) <input id="emp-wage" type="number" inputmode="numeric" min="0" step="1" style="width:120px;" /></label>
      <button id="save-emp" class="btn primary" type="button">保存</button>
      <span id="emp-msg" class="muted"></span>
    </div>

    <div class="row">
      <button id="add-emp" class="btn" type="button">＋ スタッフ追加</button>
      <button id="del-emp" class="btn warn" type="button">− スタッフ削除</button>
      <button id="move-left" class="btn" type="button">← 左へ</button>
      <button id="move-right" class="btn" type="button">→ 右へ</button>
      <button id="reset-data" class="btn" type="button">データ初期化</button>
    </div>
  </section>

  <section class="card stack">
    <h2 class="section-title">対象月 & 集計モード</h2>
    <div class="row">
      <button id="prev-month" class="btn" type="button">← 前月</button>
      <input id="month-picker" type="month" />
      <button id="next-month" class="btn" type="button">翌月 →</button>

      <span class="badge">年選択</span>
      <input id="year-picker" type="number" step="1" style="width:100px;" />

      <span class="badge">年収見込み</span>
      <select id="proj-mode">
        <option value="thismonth">今月×12（単月×12）</option>
        <option value="ytdavg">YTD平均×残り月（推奨）</option>
      </select>
    </div>
  </section>

  <!-- 希望票（AI解析 → 反映） -->
  <section class="card stack">
    <h2 class="section-title">希望票（テキスト貼り付け）→ 出勤簿へ反映</h2>
    <textarea id="wish-text" placeholder="例）扶養の範囲内で。月・火・木のみ出勤。勤務時間は4時間。祝日は休み。&#10;15日は休み、22日は入れます。"></textarea>

    <div class="row">
      <label><input id="wish-keep-existing" type="checkbox" /> 既存の入力を優先（空欄のみ埋める）</label>
    </div>

    <div class="row" id="wish-buttons">
      <button id="wish-parse-btn" class="btn" type="button">AI解析（プレビュー）</button>
      <button id="wish-apply" class="btn primary" type="button">AI解析して反映</button>
      <span id="wish-summary" class="muted"></span>
    </div>

    <div id="wish-preview" class="card muted">プレビューなし</div>
  </section>

  <section class="card stack">
    <h2 class="section-title">出勤簿（カレンダー）</h2>
    <div id="calendar"></div>
    <div class="note">※「出勤/休み」の切替、時間は数値で。30分＝0.5。</div>
  </section>

  <section class="card stack">
    <h2 class="section-title">月次集計 & 年収見込み</h2>
    <div class="row kpi">
      <div class="kpi-item">合計時間：<strong id="sum-hours">0.00 h</strong></div>
      <div class="kpi-item">合計賃金：<strong id="sum-wage">¥0</strong></div>
      <div class="kpi-item">年収見込み：<strong id="proj-annual">¥0</strong></div>
    </div>

    <div class="stack">
      <div class="bar-row"><span class="badge">103万円</span><progress id="bar-103" max="100" value="0"></progress><span id="pct-103">0%</span></div>
      <div class="bar-row"><span class="badge">106万円</span><progress id="bar-106" max="100" value="0"></progress><span id="pct-106">0%</span></div>
      <div class="bar-row"><span class="badge">130万円</span><progress id="bar-130" max="100" value="0"></progress><span id="pct-130">0%</span></div>

      <div class="row">
        <label>カスタムA(円/年) <input id="th-custom-a" type="number" inputmode="numeric" min="0" step="10000" style="width:140px;" /></label>
        <span class="bar-row"><progress id="bar-custom-a" max="100" value="0"></progress><span id="pct-custom-a">0%</span></span>
      </div>
      <div class="row">
        <label>カスタムB(円/年) <input id="th-custom-b" type="number" inputmode="numeric" min="0" step="10000" style="width:140px;" /></label>
        <span class="bar-row"><progress id="bar-custom-b" max="100" value="0"></progress><span id="pct-custom-b">0%</span></span>
      </div>

      <div id="warn" class="muted"></div>
    </div>
  </section>

  <section class="card stack">
    <h2 class="section-title">年間サマリー（各月×金額/時間）</h2>
    <div class="row"><button id="refresh-summary" class="btn" type="button">再計算</button></div>
    <div id="year-summary" class="stack"></div>
  </section>

  <section class="card stack">
    <h2 class="section-title">前月コピー</h2>
    <div class="row">
      <button id="copy-prev-fill" class="btn" type="button">前月→今月（空欄のみ）</button>
      <button id="copy-prev-overwrite" class="btn warn" type="button">前月→今月（全て上書き）</button>
    </div>
  </section>

  <!-- 一番下：エクスポート -->
  <section class="card stack" aria-labelledby="sec-export-bottom">
    <h2 id="sec-export-bottom" class="section-title">エクスポート（CSV / Excel）</h2>
    <div class="row" id="export-buttons">
      <button id="export-csv-month" class="btn" type="button">CSV（今月）</button>
      <button id="export-csv-all" class="btn" type="button">CSV（全スタッフ×全月）</button>
      <button id="export-xlsx-month" class="btn" type="button">Excel（今月 .xlsx）</button>
    </div>
    <div class="note">※ クリックしたボタンが青ハイライト（直近操作表示）。</div>
  </section>

  <footer class="stack muted" style="margin-top:16px;">
    <div>ブラウザのみで動作（localStorage 保存）。祝日取得に外部APIを使用。</div>
  </footer>

  <script src="script.js"></script>
  <script>
    // クリック強調（エクスポート）
    (function(){
      var wrap = document.getElementById('export-buttons');
      function setActive(btn){
        if(!wrap) return;
        Array.from(wrap.querySelectorAll('button')).forEach(b=>b.classList.remove('btn-active'));
        btn.classList.add('btn-active');
      }
      ['export-csv-month','export-csv-all','export-xlsx-month'].forEach(function(id){
        var el = document.getElementById(id);
        if(!el) return;
        el.addEventListener('click', function(){
          try{
            if(id==='export-csv-month') exportCsvThisMonth();
            else if(id==='export-csv-all') exportCsvAll();
            else if(id==='export-xlsx-month') exportXlsxThisMonth();
            setActive(el);
          }catch(e){ console.error(e); alert('エクスポートに失敗しました。'); }
        });
      });
    })();

    // クリック強調（AIボタン）
    (function(){
      var wrap = document.getElementById('wish-buttons');
      function setActive(btn){
        if(!wrap) return;
        Array.from(wrap.querySelectorAll('button')).forEach(b=>b.classList.remove('btn-active'));
        btn.classList.add('btn-active');
      }
      var parseBtn = document.getElementById('wish-parse-btn');
      var applyBtn = document.getElementById('wish-apply');

      if(parseBtn){
        parseBtn.addEventListener('click', function(){
          if(window.__parseWishPreview) { window.__parseWishPreview(); setActive(parseBtn); }
          else alert('script.js が読み込まれていません');
        });
      }
      if(applyBtn){
        applyBtn.addEventListener('click', function(){
          if(window.__applyFromWish) { window.__applyFromWish(); setActive(applyBtn); }
          else alert('script.js が読み込まれていません');
        });
      }
    })();
  </script>
</body>
</html>
